<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - CAD Risk Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
            <i class="bi bi-heart-pulse"></i> CAD Risk Prediction
        </a>
        <div class="navbar-nav ms-auto">
            <span class="navbar-text me-3">
                Welcome, {{ user.full_name }}
            </span>
            <a class="nav-link" href="{{ url_for('dashboard') }}">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a class="nav-link" href="{{ url_for('logout') }}">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </div>
</nav>

<div class="container mt-4">

    <h2 class="mb-4">
        <i class="bi bi-bar-chart"></i> Analytics Dashboard
    </h2>

    <!-- SUMMARY -->
    <div class="row mb-4">

        <div class="col-md-3">
            <div class="card bg-primary text-white text-center p-3">
                <h6>Total Assessments</h6>
                <h2>{{ stats.total_assessments }}</h2>
            </div>
        </div>

        {% set total = stats.total_assessments %}

        <div class="col-md-3">
            <div class="card bg-success text-white text-center p-3">
                <h6>Low Risk</h6>
                <h2>{{ stats.low_risk }}</h2>
                <small>
                    {{ ((stats.low_risk / total) * 100) | round(1) if total > 0 else 0 }}%
                </small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-warning text-dark text-center p-3">
                <h6>Medium Risk</h6>
                <h2>{{ stats.medium_risk }}</h2>
                <small>
                    {{ ((stats.medium_risk / total) * 100) | round(1) if total > 0 else 0 }}%
                </small>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card bg-danger text-white text-center p-3">
                <h6>High Risk</h6>
                <h2>{{ stats.high_risk }}</h2>
                <small>
                    {{ ((stats.high_risk / total) * 100) | round(1) if total > 0 else 0 }}%
                </small>
            </div>
        </div>

    </div>


    <!-- CHARTS -->
    <div class="row mb-4">

        <div class="col-md-8">
            <div class="card shadow p-3">
                <h5>Risk Trends</h5>

                {% if trend_dates %}
                    <canvas id="trendChart" height="120"></canvas>
                {% else %}
                    <p class="text-muted text-center">No trend data available</p>
                {% endif %}
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow p-3">
                <h5>Risk Distribution</h5>

                {% if total > 0 %}
                    <canvas id="pieChart" height="120"></canvas>
                {% else %}
                    <p class="text-muted text-center">No data available</p>
                {% endif %}
            </div>
        </div>

    </div>


    <!-- RISK FACTOR TABLE -->
    <div class="card shadow p-3 mb-4">
        <h5>Risk Factor Correlation</h5>
        <table class="table table-bordered text-center">
            <thead>
                <tr>
                    <th>Factor</th>
                    <th>High %</th>
                    <th>Medium %</th>
                    <th>Low %</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Smoking</td>
                    <td class="text-danger">{{ stats.smoking_high }}%</td>
                    <td class="text-warning">{{ stats.smoking_medium }}%</td>
                    <td class="text-success">{{ stats.smoking_low }}%</td>
                </tr>
                <tr>
                    <td>Diabetes</td>
                    <td class="text-danger">{{ stats.diabetes_high }}%</td>
                    <td class="text-warning">{{ stats.diabetes_medium }}%</td>
                    <td class="text-success">{{ stats.diabetes_low }}%</td>
                </tr>
                <tr>
                    <td>Family History</td>
                    <td class="text-danger">{{ stats.family_history_high }}%</td>
                    <td class="text-warning">{{ stats.family_history_medium }}%</td>
                    <td class="text-success">{{ stats.family_history_low }}%</td>
                </tr>
                <tr>
                    <td>Sedentary</td>
                    <td class="text-danger">{{ stats.sedentary_high }}%</td>
                    <td class="text-warning">{{ stats.sedentary_medium }}%</td>
                    <td class="text-success">{{ stats.sedentary_low }}%</td>
                </tr>
            </tbody>
        </table>
    </div>

</div>


<script>

{% if trend_dates %}
const trendCtx = document.getElementById('trendChart').getContext('2d');
new Chart(trendCtx, {
    type: 'line',
    data: {
        labels: {{ trend_dates | tojson }},
        datasets: [
            {
                label: 'Low',
                data: {{ trend_low | tojson }},
                borderColor: '#28a745',
                tension: 0.4
            },
            {
                label: 'Medium',
                data: {{ trend_medium | tojson }},
                borderColor: '#ffc107',
                tension: 0.4
            },
            {
                label: 'High',
                data: {{ trend_high | tojson }},
                borderColor: '#dc3545',
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});
{% endif %}


{% if total > 0 %}
const pieCtx = document.getElementById('pieChart').getContext('2d');
new Chart(pieCtx, {
    type: 'doughnut',
    data: {
        labels: ['Low', 'Medium', 'High'],
        datasets: [{
            data: [
                Number({{ stats.low_risk }}),
                Number({{ stats.medium_risk }}),
                Number({{ stats.high_risk }})
            ],
            backgroundColor: ['#28a745', '#ffc107', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});
{% endif %}

</script>

</body>
</html>
